@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using CitasEPS.Models

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager
@inject IAuthorizationService AuthorizationService

@{
    var isDoctorLoggedIn = false;
    var isPatientLoggedIn = false;
    var isAdminLoggedIn = false;
    var bodyClass = ""; // Default body class

    if (SignInManager.IsSignedIn(User))
    {
        var adminCheck = await AuthorizationService.AuthorizeAsync(User, "RequireAdminRole");
        isAdminLoggedIn = adminCheck.Succeeded;
        
        if (isAdminLoggedIn)
        {
            bodyClass = "admin-body-bg";
        }
        else
        {
            var doctorCheck = await AuthorizationService.AuthorizeAsync(User, "RequireDoctorRole");
            isDoctorLoggedIn = doctorCheck.Succeeded;
            if (isDoctorLoggedIn)
            {
                bodyClass = "doctor-body-bg";
            }
            else
            {
                var patientCheck = await AuthorizationService.AuthorizeAsync(User, "RequirePatientRole");
                isPatientLoggedIn = patientCheck.Succeeded;
                if (isPatientLoggedIn)
                {
                    bodyClass = "patient-body-bg";
                }
            }
        }
    }

    // Pass role information to _Navbar.cshtml
    ViewData["IsDoctorLoggedIn"] = isDoctorLoggedIn;
    ViewData["IsPatientLoggedIn"] = isPatientLoggedIn;
    ViewData["IsAdminLoggedIn"] = isAdminLoggedIn;
}

<!DOCTYPE html>
<html lang="es-CO">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - VitalCare</title>
    <link rel="icon" href="~/favicon.svg" type="image/svg+xml"> @* Favicon Link *@
    
    @* THEME SCRIPT - Apply immediately to prevent flashing *@
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
        })();
    </script>
    
    @* Bootswatch Cerulean Theme - Consider using local copy for reliability *@
    <link rel="stylesheet" href="https://bootswatch.com/5/cerulean/bootstrap.min.css" /> @* Restored Bootswatch *@
    @* Bootstrap Icons - Requires separate inclusion or project setup *@
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    @* Flatpickr CSS for date pickers *@
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    @* === CSS MODULAR PARA MEJOR RENDIMIENTO === *@
    @* Archivo CSS principal con variables y estilos base *@
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    
    @* Componentes específicos *@
    <link rel="stylesheet" href="~/css/components.css" asp-append-version="true" />
    
    @* Temas por roles *@
    <link rel="stylesheet" href="~/css/themes.css" asp-append-version="true" />
    
    @* Layout y estructura *@
    <link rel="stylesheet" href="~/css/layout.css" asp-append-version="true" />
    
    @* Efectos arcoíris y animaciones especiales *@
    <link rel="stylesheet" href="~/css/rainbow-effects.css" asp-append-version="true" />
    
    @* Archivo con efectos avanzados y estilos del footer *@
    <link rel="stylesheet" href="~/css/enhanced-features.css" asp-append-version="true" />
    
    @* Carga condicional de efectos avanzados solo para dispositivos más potentes *@
    <link rel="stylesheet" href="~/css/effects-hover.css" 
          media="(min-width: 768px) and (prefers-reduced-motion: no-preference)" 
          asp-append-version="true" />
    
    @* Estilos específicos del proyecto *@
    <link rel="stylesheet" href="~/CitasEPS.styles.css" asp-append-version="true" />
    
    <partial name="_Styles" /> @* Extracted inline styles *@

    @await RenderSectionAsync("Styles", required: false) @* Added to render page-specific styles *@
</head>
<body class="@bodyClass">
    <partial name="_Navbar" /> @* Extracted Navbar *@
    
    <div class="container mt-4">
        <main role="main" class="pb-3">
            
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>
            }
            @RenderBody()
        </main>
    </div>

    <partial name="_Footer" /> @* Extracted Footer *@

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script> 
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/site.flatpickr.js" asp-append-version="true"></script> 
    <script src="~/js/passwordToggle.js" asp-append-version="true"></script> 
    <script src="~/js/notifications.js" asp-append-version="true"></script> @* <<< Add notifications.js *@
    <script src="~/js/themeSwitcher.js" asp-append-version="true"></script> @* Add new theme switcher JS *@
    
    @* === OPTIMIZADOR DE RENDIMIENTO === *@
    @* Script opcional para optimización dinámica de animaciones *@
    <script src="~/js/performance-optimizer.js" asp-append-version="true"></script>
    
    @* === FIX ESPECÍFICO PARA LAG DE SCROLL EN HERO === *@
    @* Script especializado para eliminar lag durante scrolling *@
    <script src="~/js/scroll-performance-fix.js" asp-append-version="true"></script>
    
    @* === NAVBAR RESPONSIVO === *@
    <script src="~/js/navbarResponsive.js" asp-append-version="true"></script> 

    @* === PERFORMANCE TESTING (Solo desarrollo) === *@
    @if (Context.Request.Host.Host.Contains("localhost"))
    {
        <script src="~/js/scroll-performance-test.js" asp-append-version="true"></script>
    }

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>